# 전투 페이싱 모델 (TTK / EHP)

## 빠른 내비게이션

### 언제 이 문서를 여는가

- 전투가 길거나 짧아서 리듬이 어색할 때
- 레벨/티어별 적 HP를 목표 TTK에 맞춰 역산해야 할 때
- 클래스/빌드 간 처치 속도 편차를 수치로 비교해야 할 때

### Quick Formula

```
TTK = EHP / DPS
EHP = HP / (1 - 피해감소율)
목표HP = 목표TTK × 기대DPS × 피해유입계수
총보스시간 = Σ(페이즈 TTK) + Σ(전환 시간)
```

### 목차

- 1. 핵심 지표 정의
- 2. 플레이어 실효 DPS 계산
- 3. 적 실효 EHP 계산
- 4. 장르/콘텐츠별 목표 TTK 밴드
- 5. 목표 TTK에서 적 HP 역산
- 6. 샘플 몬스터 아키타입 계산
- 7. TTK 분산과 체감 공정성
- 8. 보스 페이즈 시간 예산
- 9. 스프레드시트/Unity 계산 템플릿
- 10. 텔레메트리 검증 항목
- 설계 체크리스트

## 1. 핵심 지표 정의

전투 난이도는 결국 다음 3개로 수렴한다.

- `실효 DPS (Damage Per Second)`
- `실효 EHP (Effective Health Pool)`
- `TTK (Time-To-Kill)`

기본 식:

```
TTK = EHP / DPS
```

| 지표 | 의미 | 설계 질문 |
|------|------|-----------|
| DPS | 플레이어가 1초에 넣는 기대 피해량 | 이 클래스/빌드가 의도한 처치 속도를 내는가? |
| EHP | 적이 실제로 버티는 체력 | 방어 기믹이 너무 과한가? |
| TTK | 처치까지 걸리는 시간 | 전투 리듬이 장르/콘텐츠 의도와 맞는가? |

---

## 2. 플레이어 실효 DPS 계산

### 2-1. 1회 공격 기대 피해

```
기대피해(타당) = 기본피해 × 명중률 × (1 + 치명타율 × (치명배율 - 1)) × 스킬계수 × 기타계수
```

- 기타계수: 속성 상성, 취약 상태, 버프/디버프, 부위 배율 등
- 치명배율은 `1.5`처럼 배수 기준으로 표기 (예: 150% = 1.5)

### 2-2. 로테이션 기반 DPS

```
DPS = Σ(스킬 i의 기대피해 × 초당 사용횟수 × 유지율)
```

예시:

| 스킬 | 기대피해(1회) | 초당 사용횟수 | 유지율 | 기여 DPS |
|------|---------------|---------------|--------|----------|
| 기본 공격 | 132.5 | 2.5 | 1.0 | 331.2 |
| 스킬 A | 555.8 | 0.2 | 1.0 | 111.2 |
| 도트 B | 80.0 | 1.0 | 0.6 | 48.0 |
| **합계** | - | - | - | **490.4** |

### 2-3. Burst vs Sustain 분리

동일 평균 DPS라도 체감이 다르다.

- `Burst DPS`: 3~8초 창에서의 최고 DPS
- `Sustain DPS`: 30~90초 평균 DPS

보스 설계 시 권장:

| 상황 | 기준 |
|------|------|
| 짧은 패턴 붕괴 방지 | Burst 기준 TTK를 하한으로 본다 |
| 장기전 피로도 관리 | Sustain 기준 TTK를 상한으로 본다 |

---

## 3. 적 실효 EHP 계산

### 3-1. 단일 감소식

```
피해감소율 = 방어력 / (방어력 + K)
EHP = HP / (1 - 피해감소율)
```

### 3-2. 다중 감소식 (권장: 곱연산)

```
피해유입계수 = ∏(1 - 감소요소_i)
총피해감소율 = 1 - 피해유입계수
EHP = HP / 피해유입계수
```

예시: 방어 25%, 저항 20%, 보호막 10%

```
피해유입계수 = 0.75 × 0.80 × 0.90 = 0.54
총피해감소율 = 46%
HP 12,000 -> EHP 22,222
```

### 3-3. 관통/취약 적용 순서

순서가 바뀌면 체감이 크게 달라진다.

권장 순서:

1. 공격 계수(기본 피해, 스킬 계수)
2. 공격자 버프/피해증가
3. 방어자 감소요소(방어/저항/감쇠)
4. 최종 보정(취약, 백어택, 부위)

---

## 4. 장르/콘텐츠별 목표 TTK 밴드 (휴리스틱)

| 콘텐츠 | 권장 TTK | 의도 |
|--------|----------|------|
| 잡몹(핵앤슬래시) | 0.8~2.0초 | 무쌍감, 속도감 |
| 잡몹(전술 RPG) | 4~10초 | 판단/스킬 교환 |
| 엘리트 | 8~20초 | 패턴 인식, 자원 소모 |
| 미니보스 | 20~45초 | 빌드 검증 |
| 보스 1페이즈 | 35~90초 | 학습 + 수행 |
| 레이드 보스(파티) | 3~8분 | 역할 분담, 실패 복구 |

주의:

- TTK 자체보다 `TTK 분산`이 체감 공정성에 더 큰 영향을 준다.
- 동일 콘텐츠라도 솔플/파티, 근접/원거리 빌드를 분리해 본다.

---

## 5. 목표 TTK에서 적 HP 역산

설계에서 가장 자주 쓰는 역산식:

```
목표HP = 목표TTK × 기대DPS × 피해유입계수
```

레벨별 예시:

| 레벨 | 기대 DPS | 목표 TTK | 피해유입계수(=1-감소율) | 역산 HP |
|------|----------|----------|-------------------------|---------|
| 10 | 800 | 8초 | 0.85 | 5,440 |
| 20 | 1300 | 9초 | 0.78 | 9,126 |
| 30 | 2100 | 10초 | 0.72 | 15,120 |
| 40 | 3200 | 11초 | 0.68 | 23,936 |

이 방식으로 "플레이어 화력 성장"과 "적 체력 성장"을 동기화한다.

---

## 6. 샘플 몬스터 아키타입 계산

플레이어 기대 DPS = `1,800`일 때:

| 아키타입 | HP | 피해감소율 | EHP | TTK |
|----------|----|-----------|-----|-----|
| 잡몹 | 3,000 | 10% | 3,333 | 1.9초 |
| 엘리트 | 12,000 | 20% | 15,000 | 8.3초 |
| 미니보스 | 45,000 | 30% | 64,286 | 35.7초 |
| 보스 페이즈 | 90,000 | 35% | 138,462 | 76.9초 |

---

## 7. TTK 분산과 체감 공정성

평균 TTK만 맞추면 실패한다. 아래를 같이 본다.

- `p50 TTK`: 일반적인 체감
- `p90 TTK`: "운 나쁜 판" 체감
- `p10 TTK`: "운 좋은 판" 체감

권장 가이드:

| 지표 | 권장 |
|------|------|
| p90 / p50 | 1.25 이하 |
| p50 / p10 | 1.35 이하 |
| 극단값(1% tail) | 파훼 불가 수준이면 안 됨 |

분산이 큰 원인:

- 명중/치명 RNG 비중 과다
- 회피/막기 연속 발생
- 핵심 스킬 의존도가 지나치게 큼

완화 레버:

- 소프트 보정(연속 비치명 후 치명 가중)
- 명중 하한 보장
- 핵심 스킬 실패 시 부분 환급

---

## 8. 보스 페이즈 시간 예산

총 전투 시간은 페이즈 TTK 합 + 전환 시간이다.

```
총보스시간 = Σ(페이즈 TTK) + Σ(무적/연출/이동 시간)
```

예시:

| 구간 | 시간 |
|------|------|
| 페이즈 1 | 35초 |
| 전환 1 | 8초 |
| 페이즈 2 | 45초 |
| 전환 2 | 10초 |
| 페이즈 3 | 55초 |
| **총합** | **153초** |

보스가 길다고 느껴지는 대표 조건:

- 페이즈 전환이 잦고 조작 없는 시간 비중이 큼
- 낮은 HP가 아니라 낮은 "유효딜 타임"이 원인

---

## 9. 스프레드시트/Unity 계산 템플릿

### 스프레드시트

```
기대피해(타당): =기본피해*명중률*(1+치명타율*(치명배율-1))*계수
EHP: =HP/(1-피해감소율)
TTK: =EHP/DPS
HP역산: =목표TTK*DPS*(1-피해감소율)
```

### Unity (C#)

```csharp
float ExpectedHitDamage(
    float baseDamage,
    float hitRate,
    float critRate,
    float critMultiplier,
    float skillCoeff = 1f,
    float extraCoeff = 1f)
{
    return baseDamage
        * hitRate
        * (1f + critRate * (critMultiplier - 1f))
        * skillCoeff
        * extraCoeff;
}

float EffectiveHp(float hp, float mitigation)
    => hp / Mathf.Max(0.0001f, 1f - mitigation);

float TimeToKill(float ehp, float dps)
    => ehp / Mathf.Max(0.0001f, dps);
```

---

## 10. 텔레메트리 검증 항목

출시 후 최소 수집 권장:

1. 콘텐츠별 `p50/p90 TTK`
2. 전투 시작 후 10초 이내 사망률
3. 보스 페이즈별 평균 소요 시간
4. 빌드/클래스별 TTK 편차
5. 재도전 횟수와 포기율

경보 예시:

- p90 TTK가 목표 상한의 `+25%` 초과 시 난이도/체력 재조정
- 특정 빌드의 p50 TTK가 중앙값 대비 `-35%` 이하이면 OP 의심

---

## 설계 체크리스트

1. [ ] 콘텐츠 타입별 목표 TTK 밴드가 먼저 정의되어 있는가?
2. [ ] DPS는 Burst/Sustain으로 분리해서 계산했는가?
3. [ ] EHP는 다중 감소식을 곱연산으로 처리했는가?
4. [ ] 목표 TTK로 적 HP를 역산했는가?
5. [ ] 평균뿐 아니라 p90/p10 분산을 확인했는가?
6. [ ] 보스 연출 시간 포함 총 전투 시간을 검증했는가?
7. [ ] 출시 후 모니터링할 로그 포인트를 정의했는가?

---

## 다음으로 볼 문서

- `./encounter-clear-probability.md` (목표 클리어율/재시도 횟수로 난이도 보정)
- `./curve-genre-tempo.md` (장르 템포에 맞는 난이도 곡선 선택)
- `./economy-faucet-sink.md` (전투 보상 변경이 경제에 미치는 영향 확인)
