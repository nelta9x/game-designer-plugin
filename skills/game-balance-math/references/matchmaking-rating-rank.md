# 매치메이킹 & 랭크 설계 (Rating / Queue / Rank)

## 빠른 내비게이션

### 언제 이 문서를 여는가

- 매칭 시스템의 레이팅 모델을 선택해야 할 때
- 매칭 품질과 대기 시간 사이의 트레이드오프를 조정해야 할 때
- 랭크/티어 분포를 설계하거나 시즌 리셋 전략을 정해야 할 때

### Quick Formula

```
Elo 업데이트: R' = R + K × (S - E)
기대 승률:    E  = 1 / (1 + 10^((R_opp - R) / 400))
매칭 품질:    Q  = 1 - |R₁ - R₂| / MaxGap
소프트 리셋:  R_new = R_old × α + R_anchor × (1 - α)
```

### 목차

- 1. 레이팅 시스템 기초
- 2. 캘리브레이션 (배치 매치)
- 3. 매칭 품질 vs 대기 시간
- 4. 팀 밸런싱
- 5. 랭크/티어 분포 설계
- 6. 시즌 리셋 전략
- 7. 텔레메트리 검증 항목
- 이 문서의 범위 밖
- 설계 체크리스트

## 1. 레이팅 시스템 기초

### 1-1. Elo

가장 단순하고 널리 쓰이는 모델. 체스에서 시작, 1v1 게임에 적합.

**업데이트 공식:**

```
E = 1 / (1 + 10^((R_opp - R_me) / 400))
R' = R + K × (S - E)
```

| 파라미터 | 의미 | 일반적 값 |
|----------|------|-----------|
| R | 현재 레이팅 | 시작 1200 또는 1500 |
| E | 기대 승률 (0~1) | 레이팅 차이로 결정 |
| S | 실제 결과 | 승리=1, 무승부=0.5, 패배=0 |
| K | 변동 폭 (민감도) | 신규 32, 안정 16 |
| 400 | 스케일 상수 | 400 차이 ≈ 기대 승률 91% |

**K-factor 설계:**

| 구간 | K값 | 의도 |
|------|-----|------|
| 배치/신규 (0~30경기) | 32~40 | 빠른 수렴 |
| 안정기 (30~100경기) | 20~24 | 적당한 반응성 |
| 고정기 (100+경기) | 12~16 | 안정적 유지 |

**장점**: 이해하기 쉬움, 구현 간단, 검증된 역사
**한계**: 불확실성(신뢰도) 표현 불가, 비활동 처리 없음, 팀 게임 확장 어려움

### 1-2. Glicko-2

Elo에 **신뢰 구간(RD)**과 **변동성(σ)**을 추가한 모델.

**핵심 개념:**

- `μ` (mu): 실력 추정값 (Elo의 R에 해당)
- `RD` (Rating Deviation): 추정의 불확실성. 경기할수록 줄고, 안 하면 늘어남
- `σ` (sigma): 실력 자체의 변동성 (갑자기 늘거나 줄 수 있는 정도)

**RD 변화 패턴:**

```
경기 직후: RD 감소 (확신 증가)
비활동 시: RD 증가 (확신 감소)
RD 상한:   350 (사실상 "모름" 상태)
RD 하한:   30~50 (매우 확신)
```

| 상황 | RD 효과 |
|------|---------|
| 새 플레이어 | RD 높음 → 매칭 범위 넓음 → 빠른 배치 |
| 숙련 플레이어 | RD 낮음 → 매칭 범위 좁음 → 정밀 매칭 |
| 복귀 플레이어 | RD 재상승 → 실력 변화 반영 |

**장점**: 불확실성 기반 매칭 가능, 비활동 처리 내장
**한계**: Elo보다 복잡, 팀 게임 확장에 추가 작업 필요

### 1-3. TrueSkill

Microsoft 개발. 팀 기반, 멀티플레이어 대응.

**핵심 개념:**

- 각 플레이어를 `(μ, σ)` 가우시안으로 표현
- 팀 실력 = 팀원 `μ` 합산
- 경기 결과로 각 플레이어의 `μ, σ`를 베이지안 업데이트

**보수적 실력 추정:**

```
Conservative Rating = μ - 3σ
```

매칭과 리더보드에는 이 보수적 추정치를 사용한다. 불확실한 플레이어가 과대평가되는 것을 방지.

**장점**: 팀 게임/멀티플레이어 네이티브 지원, FFA(자유 대전) 대응 가능
**한계**: 구현 복잡(팩터 그래프), 파라미터 튜닝 난이도 높음

### 1-4. 모델 선택 기준

| 상황 | 권장 모델 |
|------|----------|
| 1v1, 단순 구현 | Elo |
| 1v1, 비활동 플레이어 많음 | Glicko-2 |
| 팀 기반 (3v3, 5v5) | TrueSkill 또는 Glicko-2 확장 |
| FFA / 배틀로얄 (소규모) | TrueSkill |
| 캐주얼 / 빠른 프로토타입 | Elo |

---

## 2. 캘리브레이션 (배치 매치)

신규 플레이어의 실력을 빠르게 추정하는 초기 경기 구간.

### 설계 요소

| 요소 | 일반적 범위 | 설계 질문 |
|------|-------------|-----------|
| 배치 경기 수 | 5~10판 | 정확도와 진입 장벽의 균형 |
| 초기 K-factor | 32~50 | 높을수록 빠른 수렴, 높을수록 변동도 큼 |
| 초기 레이팅 | 중앙값 (1200~1500) | 모든 신규가 같은 곳에서 시작 |
| 매칭 범위 | 넓게 (±300~500) | 다양한 실력 상대와 매칭하여 정보 수집 |

### 수렴 속도

Elo 기준, K=32일 때 레이팅 수렴까지 대략적 경기 수:

```
실력 차이 200 이내: ~15경기
실력 차이 400 이내: ~25경기
실력 차이 600 이내: ~40경기
```

Glicko-2는 RD가 자연 감소하므로, RD < 75 도달 시점을 배치 완료로 볼 수 있다.

### 주의사항

- 배치 중 패배가 과도하면 이탈. 배치 기간 동안 별도 UI(진행 바 등)로 "아직 측정 중"임을 전달
- 배치 결과로 너무 높은 랭크를 주면 이후 연패 → 좌절. 보수적 배치 후 빠른 승급이 체감이 낫다

---

## 3. 매칭 품질 vs 대기 시간

매치메이킹의 핵심 트레이드오프.

### 3-1. 매칭 품질 지표

```
Quality = 1 - |R₁ - R₂| / MaxGap
```

| 레이팅 차이 | Quality (MaxGap=400) | 체감 |
|-------------|---------------------|------|
| 0 | 1.00 | 완벽한 매칭 |
| 50 | 0.88 | 거의 동등 |
| 100 | 0.75 | 약간 차이 느낌 |
| 200 | 0.50 | 실력 차이 체감됨 |
| 400+ | 0.00 | 원사이드 |

Glicko-2/TrueSkill에서는 RD/σ 겹침으로 더 정교한 품질 측정 가능.

### 3-2. 시간 기반 허용폭 확장

대기 시간이 길어지면 매칭 범위를 점진적으로 넓힌다.

```
허용범위(t) = 기본범위 + 확장속도 × t
```

예시:

| 대기 시간 | 허용 레이팅 차이 | 예상 Quality |
|-----------|-----------------|-------------|
| 0~10초 | ±50 | 0.88+ |
| 10~30초 | ±100 | 0.75+ |
| 30~60초 | ±200 | 0.50+ |
| 60~120초 | ±300 | 0.25+ |
| 120초+ | ±400 (상한) | 최소 보장 |

**상한이 필요한 이유**: 무제한 확장하면 레이팅 차이 800+ 매칭이 발생. 차라리 대기가 긴 게 낫다.

### 3-3. 플레이어 풀 크기의 영향

| 동시접속(해당 MMR ±200 구간) | 매칭 가능성 | 권장 전략 |
|------------------------------|------------|----------|
| 1,000+ | 높음 | 좁은 범위 유지 가능 |
| 100~1,000 | 중간 | 시간 기반 확장 필수 |
| 100 미만 | 낮음 | 넓은 범위 + AI 백필 또는 비동기 매칭 검토 |

---

## 4. 팀 밸런싱

### 4-1. 팀 MMR 계산

**평균 방식 (기본):**

```
Team MMR = Σ(Player MMR) / N
```

**가중 방식 (역할/포지션이 중요한 경우):**

```
Team MMR = Σ(Player MMR × Role Weight) / Σ(Role Weight)
```

예시 (5v5 MOBA):

| 역할 | 가중치 | 이유 |
|------|--------|------|
| 미드/캐리 | 1.3 | 게임 영향력 높음 |
| 정글 | 1.2 | 초반 주도권 |
| 서포트 | 0.8 | 개인 캐리력 낮음 |

**주의**: 가중치는 게임 특성에 따라 완전히 달라진다. 위 예시를 그대로 쓰지 말고 자기 게임의 역할별 승률 기여도를 데이터로 검증해야 한다.

### 4-2. 팀 간 밸런싱 목표

| 지표 | 목표 |
|------|------|
| 팀 평균 MMR 차이 | ±25 이내 |
| 팀 내 MMR 분산 차이 | 비슷해야 함 (한쪽만 초보+고수 조합 방지) |
| 기대 승률 | 45~55% |

### 4-3. 파티 매칭 보정

파티는 소통 이점이 있으므로 보정이 필요하다.

```
보정 MMR = 파티 평균 MMR + 파티 보너스
```

| 파티 규모 | 보너스 (휴리스틱) |
|-----------|------------------|
| 2인 | +50~75 |
| 3인 | +100~125 |
| 5인 (풀파티) | +150~200 |

정확한 보너스는 파티 vs 솔로 승률 데이터로 보정한다.

---

## 5. 랭크/티어 분포 설계

### 5-1. 기본 원칙

레이팅은 내부 값, 랭크는 플레이어에게 보여주는 등급이다. 랭크의 목적:

1. **위치감**: "나는 상위 몇 %인가"
2. **목표**: "다음 등급까지 얼마나 남았나"
3. **매칭 기대**: "이 등급에서는 이 정도 실력을 기대할 수 있다"

### 5-2. 분포 설계 예시

정규분포 기반, 중앙값을 골드(중간 등급)에 배치하는 전형적 구조:

| 티어 | 인구 비율 | 레이팅 범위 (μ=1500, σ=300) |
|------|----------|----------------------------|
| 브론즈 | 10% | ~1115 이하 |
| 실버 | 25% | 1115~1385 |
| 골드 | 30% | 1385~1615 |
| 플래티넘 | 20% | 1615~1811 |
| 다이아몬드 | 10% | 1811~1994 |
| 마스터 | 4% | 1994~2198 |
| 그랜드마스터 | 1% | 2198 이상 |

**경계값 산출:**

```
경계 = μ + z × σ
```

z값 예시: 하위 10% → z = -1.28, 상위 5% → z = +1.645

### 5-3. 승급/강등 설계

| 방식 | 장점 | 단점 |
|------|------|------|
| 순수 레이팅 기반 | 즉각적, 투명 | 경계에서 요요 현상 |
| LP(리그 포인트) + 승급전 | 목표감, 성취감 | 복잡, "승급전 운" 불만 |
| 강등 보호 (3패 유예) | 좌절 완화 | 경계에 체류자 누적 |

---

## 6. 시즌 리셋 전략

### 6-1. 리셋 방식

**하드 리셋:**

```
R_new = R_default (모두 동일)
```

- 장점: 완전한 새 출발
- 단점: 시즌 초반 매칭 혼란 극심 (고수와 초보가 같은 풀)

**소프트 리셋 (권장):**

```
R_new = R_old × α + R_anchor × (1 - α)
```

| α | 효과 |
|---|------|
| 0.9 | 거의 유지 (약한 압축) |
| 0.75 | 적당한 리셋 |
| 0.5 | 강한 압축 (이전 시즌 절반만 반영) |

α = 0.75, R_anchor = 1500일 때:

| 이전 레이팅 | 리셋 후 |
|-------------|---------|
| 2200 | 2025 |
| 1800 | 1725 |
| 1500 | 1500 (변동 없음) |
| 1200 | 1275 |
| 800 | 975 |

### 6-2. 레이팅 인플레이션

시즌이 진행되면 상위 레이팅이 점차 팽창하는 현상.

**원인:**
- 신규 유입이 레이팅을 "생성"하고, 이탈 유저가 레이팅을 "가져감"
- 승리와 패배의 레이팅 합이 정확히 0이 아닌 경우 (K-factor 비대칭 등)

**완화 방법:**

| 방법 | 메커니즘 |
|------|----------|
| 시즌 리셋 | 정기적으로 분포 압축 |
| 비활동 감쇠 (Decay) | 일정 기간 미접속 시 레이팅 감소 |
| K-factor 비대칭 | 상위권은 패배 시 더 많이 잃도록 |

---

## 7. 텔레메트리 검증 항목

### 최소 모니터링

1. MMR 구간별 **실제 승률** (50%에 가까울수록 매칭 정확)
2. **매칭 품질 점수** 분포 (p50, p10)
3. **대기 시간** 분포 (p50, p90, p99)
4. 티어별 **실제 인구 비율** vs 목표 비율
5. 배치 완료 후 **10경기 내 승률** (50%에서 크게 벗어나면 배치 부정확)
6. 파티 vs 솔로 **승률 차이**

### 운영 경보 예시

- MMR 1500 구간 승률이 55% 이상 → 매칭 범위 또는 레이팅 수렴에 문제
- p90 대기 시간 > 120초 → 풀 부족 또는 범위가 너무 좁음
- 시즌 8주차 마스터+ 인구 비율이 목표의 1.5배 → 인플레이션 발생
- 배치 후 10경기 승률이 35% 미만인 플레이어 비율 > 15% → 배치 과대평가

---

## 이 문서의 범위 밖

아래 주제는 이 문서가 다루지 않는다. 해당 요청이 들어오면 게임의 장르와 조건을 기반으로 WebSearch로 사례를 조사한다.

- **비대칭 게임의 레이팅 보정** (예: 1v4, 공격/방어 역할이 다른 경우). 역할별 기대 승률이 50%가 아니므로 표준 Elo/Glicko가 그대로 적용되지 않는다.
- **스머프/부스팅 탐지 로직**. 레이팅 시스템이 아닌 행동 분석/머신러닝 영역이다. 탐지 후 레이팅 보정(빠른 MMR 상승 등)은 이 문서의 캘리브레이션 섹션으로 돌아올 수 있다.
- **크로스플레이 플랫폼 간 실력 보정**. 입력 장치(키보드/마우스 vs 컨트롤러)에 따른 실력 차이 보정은 게임별 데이터가 필수다.
- **대규모 배틀로얄(100인+) 전용 레이팅**. 순위 기반 점수 부여 방식이 별도로 필요하며, 표준 1v1/팀 모델과 구조가 다르다.
- **소셜/친선 매칭**. 실력 기반이 아닌 관계 기반 매칭은 레이팅 시스템 바깥의 설계다.

---

## 설계 체크리스트

1. [ ] 게임의 대전 구조(1v1/팀/FFA)에 맞는 레이팅 모델을 선택했는가?
2. [ ] K-factor 또는 σ 설정이 수렴 속도와 안정성 사이에서 적절한가?
3. [ ] 배치 경기 수와 초기 매칭 범위가 신규 플레이어 경험을 해치지 않는가?
4. [ ] 매칭 허용폭 확장 속도와 상한이 정의되어 있는가?
5. [ ] 파티 보정값이 실제 파티 vs 솔로 승률 데이터로 검증되었는가?
6. [ ] 랭크 분포 목표가 정의되어 있고, 경계값이 산출되었는가?
7. [ ] 시즌 리셋 방식(α값)과 인플레이션 완화 수단이 정해져 있는가?
8. [ ] 출시 후 모니터링할 텔레메트리 항목이 정의되어 있는가?

---

## 다음으로 볼 문서

- `./encounter-clear-probability.md` (PvE에서 매칭 기반 난이도 조정 시 클리어율 연결)
- `./economy-faucet-sink.md` (랭크 보상이 경제에 미치는 영향)
- `./curve-genre-tempo.md` (시즌 길이/리셋 주기와 장르 템포 연결)
