# 강화 기대비용 모델 (Expected Attempts / Expected Cost)

## 빠른 내비게이션

### 언제 이 문서를 여는가

- 강화 재화 소모량이 과하거나 부족한지 수치로 판단해야 할 때
- 실패 하락/파괴 규칙이 체감 비용에 주는 영향을 계산해야 할 때
- 평균뿐 아니라 p90/p95 기준으로 예산·보상·보호권 가치를 맞출 때

### Quick Formula

```
E_attempt(l->l+1) = 1 / p_l
C_total(단순형) = Σ(c_l / p_l)
E_l = 1 + p_l*E_{l+1} + q_l*(s_l*E_l + d_l*E_{l-1} + b_l*E_r)
C_l = c_l + p_l*C_{l+1} + q_l*(s_l*C_l + d_l*C_{l-1} + b_l*(k_l + C_r))
```

### 목차

- 1. 강화 시스템을 수식으로 보는 이유
- 2. 기본 표기
- 3. 가장 단순한 기준선
- 4. 하락/파괴가 있는 일반식
- 5. 실무 예시: +0 -> +5
- 6. 평균만 보면 안 되는 이유
- 7. 보호권 가치 평가
- 8. 천장/토큰형 보정 결합
- 9. 스프레드시트/코드 템플릿
- 10. 라이브 운영에서 보는 지표
- 11. 공정성/투명성 가이드
- 설계 체크리스트

## 1. 강화 시스템을 수식으로 보는 이유

강화 밸런스는 "성공 확률" 하나가 아니라 아래 4개가 함께 결정한다.

- 단계별 성공 확률
- 실패 결과(유지/하락/파괴)
- 시도 비용(재화/재료)
- 보호 장치(천장/보호권/토큰)

같은 30% 성공률이라도 실패 페널티 구조가 다르면 체감 비용은 몇 배 차이난다.

---

## 2. 기본 표기

- `l`: 현재 강화 단계 (`0 ... T`)
- `T`: 목표 단계
- `p_l`: `l -> l+1` 성공 확률
- `q_l = 1 - p_l`
- `c_l`: 단계 `l`에서 1회 시도 비용
- 실패 시 분기 비율
  - `s_l`: 유지(stay)
  - `d_l`: 하락(down)
  - `b_l`: 파괴(break)
  - `s_l + d_l + b_l = 1`
- 파괴 시 복구 단계 `r` (보통 0)
- 파괴 추가비용 `k_l` (복구 재화 등)

---

## 3. 가장 단순한 기준선

### 3-1. 실패 시 유지 (하락/파괴 없음)

```
E_attempt(l->l+1) = 1 / p_l
```

전체 기대 시도 횟수:

```
E_total(0->T) = Σ(1 / p_l), l=0..T-1
```

기대 비용:

```
C_total(0->T) = Σ(c_l / p_l), l=0..T-1
```

이 식은 "기본 sanity check"로 매우 유용하다.

---

## 4. 하락/파괴가 있는 일반식 (상태전이)

### 4-1. 기대 시도 횟수 재귀식

`E_l`: 현재 단계 `l`에서 목표 `T`까지 필요한 기대 시도 횟수라고 두면,

```
E_T = 0
E_l = 1 + p_l*E_{l+1} + q_l*(s_l*E_l + d_l*E_{l-1} + b_l*E_r)
```

정리하면:

```
E_l = (1 + p_l*E_{l+1} + q_l*(d_l*E_{l-1} + b_l*E_r)) / (1 - q_l*s_l)
```

### 4-2. 기대 비용 재귀식

`C_l`: 현재 단계 `l`에서 목표 `T`까지 필요한 기대 비용.

```
C_T = 0
C_l = c_l + p_l*C_{l+1} + q_l*(s_l*C_l + d_l*C_{l-1} + b_l*(k_l + C_r))
```

정리:

```
C_l = (c_l + p_l*C_{l+1} + q_l*(d_l*C_{l-1} + b_l*(k_l + C_r))) / (1 - q_l*s_l)
```

이 식을 단계별 연립방정식으로 풀면 평균 소모를 얻을 수 있다.

---

## 5. 실무 예시: +0 -> +5

설정:

| 단계 | 성공확률 p | 1회 비용 c | 실패 결과 |
|------|------------|------------|-----------|
| +0->+1 | 100% | 100 | 실패 없음 |
| +1->+2 | 80% | 200 | 유지 100% |
| +2->+3 | 60% | 400 | 유지 100% |
| +3->+4 | 45% | 700 | 유지 70%, 하락 30% |
| +4->+5 | 30% | 1200 | 유지 60%, 하락 30%, 파괴 10%(+0 복귀), 파괴비용 500 |

계산 결과(연립방정식 해):

| 시작 단계 | 목표 +5까지 기대 시도 | 기대 비용 |
|----------|-----------------------|-----------|
| +0 | 13.64회 | 8,850.56 |
| +1 | 12.64회 | 8,750.56 |
| +2 | 11.39회 | 8,500.56 |
| +3 | 9.73회 | 7,833.89 |
| +4 | 6.89회 | 6,033.89 |

핵심 해석:

- 마지막 단계 하나(+4->+5)가 전체 비용의 대부분을 결정한다.
- 파괴가 10%만 있어도 장기 기대비용이 크게 뛴다.

---

## 6. 평균만 보면 안 되는 이유 (퍼센타일 예산)

동일 예시를 몬테카를로로 200,000회 시뮬레이션한 결과:

| 지표 | 시도 횟수 | 누적 비용 |
|------|-----------|-----------|
| 평균 | 13.65회 | 8,858 |
| p50 | 11회 | 6,900 |
| p90 | 25회 | 17,200 |
| p95 | 31회 | 21,700 |

의미:

- "평균 8,850"만 보고 재화 패키지를 설계하면 체감 불만이 커진다.
- 운영/BM 설계는 최소 p90, 가능하면 p95까지 보고 예산을 잡는다.

---

## 7. 보호권(파괴 방지) 가치 평가

같은 예시에서 +4 단계 파괴(10%)를 제거하면:

- 기대 시도: `13.64 -> 12.07` (약 1.58회 감소)
- 기대 비용: `8,850.56 -> 8,076.67` (약 773.89 감소)

즉, +4 단계 파괴 방지 1회권의 기준 가치는 대략 다음으로 추정 가능:

```
보호권 기대가치 ≈ 파괴 제거 전후 기대비용 차이의 일부
```

주의:

- 실제 판매/획득 가치는 유저 코호트별 파괴 도달 빈도를 곱해 조정
- 보호권이 너무 강하면 강화 긴장감이 사라짐

---

## 8. 천장/토큰형 보정 결합

확률형 강화에 누적 보정을 넣으면 분산을 크게 줄일 수 있다.

예시:

1. 실패 시 토큰 +1
2. 토큰 `N` 도달 시 다음 강화 확정
3. 성공 시 토큰 초기화(또는 일부 유지)

효과:

- 평균비용은 유지하면서 p90/p95를 낮추기 쉬움
- "언젠가 된다"는 심리적 안전장치 제공

---

## 9. 스프레드시트/코드 템플릿

### 스프레드시트(단순형)

```
단계기대시도: =1/성공확률
단계기대비용: =시도비용/성공확률
총기대비용: =SUM(단계기대비용)
```

### Python (시뮬레이션)

```python
import random


def simulate_once(target=5):
    p = [1.0, 0.8, 0.6, 0.45, 0.30]
    c = [100, 200, 400, 700, 1200]
    stay = [0.0, 1.0, 1.0, 0.7, 0.6]
    down = [0.0, 0.0, 0.0, 0.3, 0.3]
    break_rate = [0.0, 0.0, 0.0, 0.0, 0.1]
    break_cost = [0, 0, 0, 0, 500]

    lv = 0
    attempts = 0
    cost = 0

    while lv < target:
        attempts += 1
        cost += c[lv]

        if random.random() < p[lv]:
            lv += 1
            continue

        r = random.random()
        if r < stay[lv]:
            pass
        elif r < stay[lv] + down[lv]:
            lv = max(0, lv - 1)
        else:
            cost += break_cost[lv]
            lv = 0

    return attempts, cost
```

---

## 10. 라이브 운영에서 보는 지표

필수:

1. 강화 단계별 성공률 실측치(설정값 대비)
2. 단계별 평균/중앙값 시도 횟수
3. 단계별 p90/p95 비용
4. 단계별 이탈률(강화 중단 지점)
5. 보호권/보정 아이템 사용률

경보 예시:

- +N 단계 p90 비용이 목표 대비 `+30%` 초과
- 특정 단계 이탈률이 전 단계 대비 `+2배` 이상
- 실측 성공률이 설정 대비 유의미하게 낮음(버그/표기 오류 가능)

---

## 11. 공정성/투명성 가이드

- 확률, 실패 결과(하락/파괴), 보호 규칙을 명시한다.
- "평균값"만이 아니라 상위 퍼센타일 체감도 내부적으로 관리한다.
- 시즌/패치에서 확률을 바꿀 때 기존 투자자 보상 정책을 함께 설계한다.

---

## 설계 체크리스트

1. [ ] 실패 결과를 유지/하락/파괴로 분리해 모델링했는가?
2. [ ] 단계별 기대 시도/기대 비용을 계산했는가?
3. [ ] 평균뿐 아니라 p90/p95 비용을 확인했는가?
4. [ ] 마지막 1~2단계가 전체 경제를 과도하게 지배하지 않는가?
5. [ ] 보호권/토큰 도입 시 분산 완화 효과를 검증했는가?
6. [ ] UI에 실패 규칙과 보정 상태를 충분히 공개하는가?

---

## 다음으로 볼 문서

- `./pity-systems.md` (강화 보정 확률/천장과 결합 설계)
- `./economy-faucet-sink.md` (강화 비용이 Sink로 작동하는 규모 점검)
- `./drop-tables.md` (강화 재료 공급량과 요구비용 동기화)
